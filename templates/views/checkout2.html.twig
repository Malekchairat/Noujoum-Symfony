{% extends 'base.html.twig' %}

{% block title %}Checkout - Noujoum{% endblock %}

{% block body %}
<!-- Start Hero Section -->
<div class="hero">
    <div class="container">
        <div class="row justify-content-between">
            <div class="col-lg-5">
                <div class="intro-excerpt">
                    <h1>Checkout</h1>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Hero Section -->

<div class="untree_co-section">
    <div class="container">
        <div class="row">
            <!-- Billing Details -->
            <div class="col-md-6 mb-5 mb-md-0">
                <h2 class="h3 mb-3 text-black">Billing Details</h2>
                <div class="p-3 p-lg-5 border bg-white">
                    {{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate', 'id': 'checkoutForm'}}) }}
                    
                    <div class="form-group row">
                        <div class="col-md-12">
                            {{ form_row(form.rue, {'attr': {'class': 'form-control'}, 'label': 'Street Address'}) }}
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-6">
                            {{ form_row(form.ville, {'attr': {'class': 'form-control'}, 'label': 'City'}) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.code_postal, {'attr': {'class': 'form-control'}, 'label': 'Postal Code'}) }}
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-12">
                            {{ form_row(form.methodePaiment, {'attr': {'class': 'form-select'}, 'label': 'Payment Method'}) }}
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-12">
                            {{ form_row(form.etat, {'attr': {'class': 'form-select'}, 'label': 'State'}) }}
                        </div>
                    </div>

                    <div class="form-group mt-4">
                        <button type="button" id="placeOrderBtn" class="btn btn-primary">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Passer la commande
                        </button>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>

            <!-- Your Order -->
            <div class="col-md-6">
                <h2 class="h3 mb-3 text-black">Your Order</h2>
                <div class="p-3 p-lg-5 border bg-white">
                    <table class="table site-block-order-table mb-5">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cartItems %}
                            <tr>
                                <td>{{ item.produit.nom }} <strong class="mx-2">x</strong> {{ item.nbrProduit }}</td>
                                <td>{{ item.getTotal() }} €</td>
                            </tr>
                            {% endfor %}
                            <tr>
                                <td class="text-black font-weight-bold"><strong>Order Total</strong></td>
                                <td class="text-black font-weight-bold"><strong>{{ total }} €</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Debug Information Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Debug Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugInfo" class="text-muted">
                            <p>Waiting for order process...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script>
function updateDebugInfo(message) {
    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
        debugInfo.textContent = message;
    }
}

function validateForm() {
    const requiredFields = ['rue', 'ville', 'code_postal', 'payment_method'];
    let isValid = true;

    requiredFields.forEach(field => {
        const input = document.getElementById(field);
        if (!input || !input.value.trim()) {
            isValid = false;
            input.classList.add('is-invalid');
        } else {
            input.classList.remove('is-invalid');
        }
    });

    // Validate postal code format (5 digits)
    const postalCode = document.getElementById('code_postal');
    if (postalCode && !/^\d{5}$/.test(postalCode.value)) {
        isValid = false;
        postalCode.classList.add('is-invalid');
    }

    return isValid;
}

document.getElementById('orderForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!validateForm()) {
        updateDebugInfo('Please fill in all required fields correctly.');
        return;
    }

    const submitButton = document.getElementById('submitOrder');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    submitButton.disabled = true;
    loadingSpinner.classList.remove('d-none');

    try {
        const formData = new FormData(this);
        const response = await fetch('{{ path('api_order_confirm', {'id': order.id}) }}', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(Object.fromEntries(formData))
        });

        const data = await response.json();

        if (response.ok) {
            updateDebugInfo('Order confirmed successfully! A confirmation email has been sent.');
            // Redirect to success page or show success message
            window.location.href = '{{ path('order_success') }}';
        } else {
            updateDebugInfo(data.error || 'An error occurred while processing your order.');
        }
    } catch (error) {
        console.error('Error:', error);
        updateDebugInfo('An unexpected error occurred. Please try again later.');
    } finally {
        submitButton.disabled = false;
        loadingSpinner.classList.add('d-none');
    }
});
</script>

<style>
.btn-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}
.btn-primary:hover {
    background-color: #2e59d9;
    border-color: #2e59d9;
}
#debugInfo {
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
    white-space: pre-wrap;
}
.is-invalid {
    border-color: #dc3545;
}
.is-valid {
    border-color: #28a745;
}
</style>
{% endblock %}