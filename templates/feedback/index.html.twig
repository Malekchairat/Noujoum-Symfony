{% extends 'base.html.twig' %}

{% block title %}My Feedbacks{% endblock %}

{% block body %}
    <div class="container py-5">
        <h1 class="mb-4 text-center text-primary">My Feedbacks</h1>

        <form method="get" action="" class="row g-3 mb-4">
            <div class="col-md-4">
                <input type="text" name="search" value="{{ app.request.get('search') }}" class="form-control" placeholder="Search by comment or note...">
            </div>
            <div class="col-md-3">
                <input type="date" name="date_from" value="{{ app.request.get('date_from') }}" class="form-control" placeholder="From date">
            </div>
            <div class="col-md-3">
                <input type="date" name="date_to" value="{{ app.request.get('date_to') }}" class="form-control" placeholder="To date">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i> Filter
                </button>
            </div>
        </form>



        {% if feedbacks is empty %}
            <div class="alert alert-info text-center">
                No feedback records found.
            </div>
        {% else %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-striped">
                    <thead class="thead-dark">
                    <tr>
                        <th scope="col">Reclamation Title</th>
                        <th scope="col">Answer</th>
                        <th scope="col">Note</th>
                        <th scope="col">Commentaire</th>
                        <th scope="col">Date Feedback</th>
                        <th scope="col">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for fb in feedbacks %}
                        <tr>
                            {% for rec in reclamations %}
                                {% if rec.id == fb.reclamationId %}
                                    <td>{{ rec.titre }}</td>
                                    <td>{{ rec.answer }}</td>
                                {% endif %}
                            {% endfor %}

                            <td>{{ fb.note }}</td>
                            <td>{{ fb.commentaire }}</td>
                            <td>{{ fb.dateFeedback|date('Y-m-d H:i') }}</td>
                            <td>
                                <form method="post"
                                      action="{{ path('app_feedback_delete', {'id': fb.id}) }}"
                                      onsubmit="return confirm('Are you sure you want to delete this feedback?');"
                                      style="display: inline;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ fb.id) }}">
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash me-1"></i> Delete
                                    </button>
                                </form>
                            </td>

                            <td>
                                <button class="btn btn-sm btn-outline-info"
                                        data-bs-toggle="modal"
                                        data-bs-target="#feedbackModal"
                                        data-feedback-id="{{ fb.id }}"
                                        data-note="{{ fb.note }}"
                                        data-commentaire="{{ fb.commentaire }}">
                                    <i class="bi bi-pencil me-1"></i> Edit
                                </button>

                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center">No records found</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
        <div class="d-flex justify-content-end mb-4">
            <a href="{{ path('app_reclamation_index') }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left-circle me-1"></i> Back to Reclamations
            </a>
        </div>
    </div>



    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">Edit Feedback</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {{ form_start(feedbackForm, {
                        'attr': {
                            'id': 'feedbackForm'
                        }
                    }) }}
                    <input type="hidden" id="feedback_reclamationId" name="reclamationId">
                    <input type="hidden" name="utilisateurId" value="1">
                    <input type="hidden" name="date_feedback" value="{{ "now"|date("Y-m-d H:i:s") }}">

                    <div class="mb-3">
                        {{ form_label(feedbackForm.note) }}
                        {{ form_widget(feedbackForm.note, {'attr': {'class': 'form-control', 'id': 'feedback_note'}}) }}
                        {{ form_errors(feedbackForm.note) }}
                    </div>
                    <div class="mb-3">
                        {{ form_label(feedbackForm.commentaire) }}
                        {{ form_widget(feedbackForm.commentaire, {'attr': {'class': 'form-control', 'id': 'feedback_commentaire', 'rows': 4}}) }}
                        {{ form_errors(feedbackForm.commentaire) }}
                    </div>

                    <div class="mt-3 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Feedback</button>
                    </div>
                    {{ form_end(feedbackForm) }}
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const feedbackModal = document.getElementById('feedbackModal');
            const feedbackForm = document.getElementById('feedbackForm');
            const noteInput = feedbackForm.querySelector('[name$="[note]"]');
            const commentaireInput = feedbackForm.querySelector('[name$="[commentaire]"]');

            feedbackModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const feedbackId = button.getAttribute('data-feedback-id');
                const note = button.getAttribute('data-note');
                const commentaire = button.getAttribute('data-commentaire');

                // Set values into form fields
                noteInput.value = note;
                commentaireInput.value = commentaire;

                // Set the correct form action
                feedbackForm.setAttribute('action', `/feedback/edit/${feedbackId}`);
            });

            // Handle form submit via AJAX
            feedbackForm.addEventListener('submit', function (e) {
                e.preventDefault(); // prevent normal form submission

                const actionUrl = feedbackForm.getAttribute('action');
                const formData = new FormData(feedbackForm);

                fetch(actionUrl, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            // Close modal
                            const modalInstance = bootstrap.Modal.getInstance(feedbackModal);
                            modalInstance.hide();

                            // Refresh page after a short delay
                            setTimeout(() => {
                                window.location.reload();
                            }, 300);
                        } else {
                            alert('Failed to update feedback.');
                        }
                    })
                    .catch(error => {
                        console.error('Submission error:', error);
                        alert('An error occurred. Please try again.');
                    });
            });
        });


    </script>

{% endblock %}