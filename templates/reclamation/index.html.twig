{% extends 'base.html.twig' %}

{% block title %}My Reclamations{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    body {
        background-color: #1e1e1e;
        color: white;
    }

    .container {
        background-color: #1e1e1e;
    }

    .btn-gold {
        background-color: #d4af37;
        color: black;
        border: none;
    }

    .btn-gold:hover {
        background-color: #c9a032;
        color: white;
    }

    .btn-view-feedback {
        background-color: #d4af37;
        color: black;
        border: none;
    }

    .btn-view-feedback:hover {
        background-color: #c9a032;
        color: white;
    }

    .list-group-item {
        background-color: #2a2a2a;
        border: 1px solid #d4af37;
        color: white;
    }

    .form-control, .form-select {
        background-color: #2a2a2a;
        border: 1px solid #555;
        color: white;
    }

    .form-control::placeholder {
        color: #aaa;
    }

    .form-select option {
        color: black;
    }

    .modal-content {
        background-color: #2a2a2a;
        color: white;
        border: 1px solid #d4af37;
    }

    .modal-header, .modal-body {
        border-bottom: 1px solid #d4af37;
    }

    .btn-close {
        background-color: white;
    }
</style>
{% endblock %}

{% block body %}
<div class="container py-5">
    <h1 class="mb-4">My Reclamations</h1>

    <div class="d-flex justify-content-end mb-4">
        <a href="{{ path('app_reclamation_new') }}" class="btn btn-success">
            <i class="bi bi-plus-circle me-1"></i> Add Reclamation
        </a>
    </div>

    <form method="get" class="mb-4 row g-3">
        <div class="col-md-6">
            <input type="text" name="search" class="form-control" placeholder="Search by title or description"
                   value="{{ search ?? '' }}">
        </div>
        <div class="col-md-4">
            <select name="status" class="form-select">
                <option value="">All Statuses</option>
                <option value="PENDING" {{ statusFilter == 'PENDING' ? 'selected' }}>Pending</option>
                <option value="RESOLVED" {{ statusFilter == 'RESOLVED' ? 'selected' }}>Resolved</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-gold w-100">
                <i class="bi bi-filter me-1"></i> Filter
            </button>
        </div>
    </form>

    {% if reclamations is empty %}
        <div class="alert alert-info">
            You haven't submitted any reclamations yet.
        </div>
    {% else %}
        <div class="list-group">
            {% for reclamation in reclamations %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">{{ reclamation.titre }}</h5>
                            <small class="text-muted">
                                Submitted on {{ reclamation.dateCreation|date('Y-m-d H:i') }}
                            </small>
                            {% if reclamation.answer %}
                                <p class="mt-2 text-success">
                                    <strong>Response:</strong> {{ reclamation.answer }}
                                </p>
                            {% endif %}
                        </div>
                        <div>
                            <span class="badge bg-{{ reclamation.statut == 'RESOLVED' ? 'success' : 'warning' }} me-2">
                                {{ reclamation.statut|lower|capitalize }}
                            </span>

                            {% if reclamation.answer %}
                                {% set feedbackExists = false %}
                                {% for feedback in feedbacks %}
                                    {% if feedback.reclamationId == reclamation.id %}
                                        {% set feedbackExists = true %}
                                    {% endif %}
                                {% endfor %}

                                {% if feedbackExists %}
                                    <a href="{{ path('app_feedback_index') }}" class="btn btn-sm btn-view-feedback">
                                        <i class="bi bi-chat-left-text me-1"></i>View Feedback
                                    </a>
                                {% else %}
                                    <button class="btn btn-sm btn-gold"
                                            data-bs-toggle="modal"
                                            data-bs-target="#feedbackModal"
                                            data-reclamation-id="{{ reclamation.id }}">
                                        <i class="bi bi-chat-left-text me-1"></i>Give Feedback
                                    </button>
                                {% endif %}
                            {% endif %}

                            {% if not reclamation.answer %}
                                <a href="{{ path('app_reclamation_edit', {'id': reclamation.id}) }}"
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                            {% endif %}

                            <form method="post" action="{{ path('app_reclamation_delete', {'id': reclamation.id}) }}"
                                  onsubmit="return confirm('Are you sure you want to delete this reclamation?');"
                                  style="display:inline-block;">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reclamation.id) }}">
                                <button class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">Submit Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {{ form_start(feedbackForm, {
                    'attr': {
                        'id': 'feedbackForm',
                        'data-url': path('app_feedback_new')
                    }
                }) }}
                <input type="hidden" name="reclamationId" id="feedback_reclamationId">
                <input type="hidden" name="utilisateurId" value="1">
                <input type="hidden" name="date_feedback" value="{{ "now"|date("Y-m-d H:i:s") }}">

                <div class="mb-3">
                    {{ form_label(feedbackForm.note) }}
                    {{ form_widget(feedbackForm.note, {'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(feedbackForm.note) }}
                </div>
                <div class="mb-3">
                    {{ form_label(feedbackForm.commentaire) }}
                    {{ form_widget(feedbackForm.commentaire, {'attr': {'class': 'form-control', 'rows': 4}}) }}
                    {{ form_errors(feedbackForm.commentaire) }}
                </div>

                <div class="mt-3 d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-gold">Submit Feedback</button>
                </div>
                {{ form_end(feedbackForm) }}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackForm = document.getElementById('feedbackForm');

        feedbackModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const reclamationId = button.getAttribute('data-reclamation-id');
            document.getElementById('feedback_reclamationId').value = reclamationId;
        });

        feedbackForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            try {
                const response = await fetch(this.dataset.url, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.status === 204 || response.status === 201) {
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert(data.errors.join('\n'));
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Network error - please try again');
            }
        });
    });
</script>
{% endblock %}
